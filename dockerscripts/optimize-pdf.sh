set -e                                                                                                                                                                                                                                                                                                                                                                                                                                INPUT=$1                                                                                                                                                                                                           PRESET=${3:-'default'}                                                                                                                                                                                             # ### Available presets:                                                                                                                                                                                           # - screen selects low-resolution output similar to the Acrobat Distiller "Screen Optimized" setting.                                                                                                              # - ebook selects medium-resolution output similar to the Acrobat Distiller "eBook" setting.                                                                                                                       # - printer selects output similar to the Acrobat Distiller "Print Optimized" setting.                                                                                                                             # - prepress selects output similar to Acrobat Distiller "Prepress Optimized" setting.                                                                                                                             # - default selects output intended to be useful across a wide variety of uses, possibly at the expense of a larger output file.                                                                                                                                                                                                                                                                                                      function optimize () {                                                                                                                                                                                             gs \                                                                                                                                                                                                                         -q -dNOPAUSE -dBATCH -dSAFER          \                                                                                                                                                                            -sDEVICE=pdfwrite                     \                                                                                                                                                                            -dCompatibilityLevel=1.3              \                                                                                                                                                                            "-dPDFSETTINGS=/${PRESET}"                    \                                                                                                                                                                    -dEmbedAllFonts=true                  \                                                                                                                                                                            -dSubsetFonts=true                    \                                                                                                                                                                            -dAutoRotatePages=/None               \                                                                                                                                                                            -sOutputFile="${2}"                   \                                                                                                                                                                            "${1}"                                                                                                                                                                                                   }                                                                                                                                                                                                                                                                                                                                                                                                                                     echo "$(date) Generating WebP images $with params: ${PARAMS}"                                                                                                                                                      export COUNTER=0                                                                                                                                                                                                   TOTAL="$(find "${INPUT}" -type f -name '*.pdf' -and -not -name '*.tmp*' | wc -l)"                                                                                                                                                                                                                                                                                                                                                     for input in $(find "${INPUT}" -type f -name '*.pdf' -and -not -name '*.tmp*' | sort -u); do                                                                                                                           output="${input%.*}-optimized.pdf"                                                                                                                                                                                 if [[ ! -f "${output}" ]] ; then                                                                                                                                                                                       optimize "${input}" "${output}"                                                                                                                                                                                    echo "[$(date +%s)] - ${COUNTER} / ${TOTAL} - ${input} ($(stat ${input} --format %s)) -> ${output} ($(stat ${output} --format %s))"                                                                            else                                                                                                                                                                                                                   echo "[$(date +%s)] - ${COUNTER} / ${TOTAL} - output file already exists: ${o} ($(stat ${output} --format %s)), doing nothing"                                                                                 fi                                                                                                                                                                                                                 COUNTER++                                                                                                                                                                                                      done
